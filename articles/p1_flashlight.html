<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using flashlight • flashlight</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using flashlight">
<meta property="og:description" content="flashlight">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flashlight</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.8.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/p1_flashlight.html">Using flashlight</a>
    </li>
    <li>
      <a href="../articles/p2_caret.html">Using flashlight with caret</a>
    </li>
    <li>
      <a href="../articles/p3_mlr3.html">Using flashlight with mlr3</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mayer79/flashlight/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using flashlight</h1>
            
            <h4 data-toc-skip class="date">2023-04-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mayer79/flashlight/blob/HEAD/vignettes/p1_flashlight.Rmd" class="external-link"><code>vignettes/p1_flashlight.Rmd</code></a></small>
      <div class="hidden name"><code>p1_flashlight.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mayer79/flashlight" class="external-link">flashlight</a></span><span class="op">)</span>      <span class="co"># model interpretation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mayer79/MetricsWeighted" class="external-link">MetricsWeighted</a></span><span class="op">)</span> <span class="co"># metrics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>           <span class="co"># data prep</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://moderndive.github.io/moderndive/" class="external-link">moderndive</a></span><span class="op">)</span>      <span class="co"># data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bethatkinson/rpart" class="external-link">rpart</a></span><span class="op">)</span>           <span class="co"># used if XGBoost not available</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/imbs-hl/ranger" class="external-link">ranger</a></span><span class="op">)</span>          <span class="co"># random forest</span></span>
<span></span>
<span><span class="va">has_xgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"xgboost"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">has_xgb</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Since XGBoost is not available, will use rpart."</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In contrast to classical statistical modelling techniques like linear
regression, modern machine learning approaches tend to provide black box
results. In areas like visual computing or natural language processing,
this is not an issue since their focus is usually on predicting things.
Either the predictions are sufficiently useful in practice or the model
won’t be used. However, in areas where the purpose of a statistical
model is also to explain or validate underlying theories (e.g. in
medicine, economics, and biology), black box models are of little
use.</p>
<p>Thus, there is need to shed light into these black boxes resp. to
explain machine learning models as good as possible. An excellent
reference is the online book <span class="citation">(<a href="#ref-molnar" role="doc-biblioref">Molnar 2019</a>)</span>. Of
special interest are <strong>model agnostic</strong> approaches that
work for any kind of modelling technique, e.g. a linear regression, a
neural net or a tree-based method. The only requirement is the
availability of a prediction function, i.e. a function that takes a data
set and returns predictions.</p>
<p>This is the purpose of the R package <code>flashlight</code>, which
is inspired by the beautiful <code>DALEX</code> package, see (<a href="https://CRAN.R-project.org/package=DALEX" class="external-link uri">https://CRAN.R-project.org/package=DALEX</a>).</p>
<p>The main props of <code>flashlight</code>:</p>
<ol style="list-style-type: decimal">
<li><p>It is simple, yet flexible.</p></li>
<li><p>It offers model agnostic tools like model performance, variable
importance, global surrogate models, ICE profiles, partial dependence,
further effects plots, scatter plots, interaction strength, and variable
contribution breakdown for single observations.</p></li>
<li><p>It allows to assess multiple models in parallel without any
redundancy in the code.</p></li>
<li><p>It supports “group by” operations.</p></li>
<li><p>All methods are able to utilize case weights.</p></li>
</ol>
<p>Currently, models with numeric or binary response are supported.</p>
<p>We will now give a brief introduction to machine learning
explanations and then illustrate them with the <code>flashlight</code>
package.</p>
</div>
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>Important model agnostic machine learning explanations include the
following aspects, amongst many others.</p>
<div class="section level3">
<h3 id="model-performance">Model performance<a class="anchor" aria-label="anchor" href="#model-performance"></a>
</h3>
<p>How precise are models if applied to unseen data? This aspect is of
key interest of basically any supervised machine learning model and
helps to identify the best models or, if applied to subgroups, identify
problematic segments with low performance.</p>
</div>
<div class="section level3">
<h3 id="variable-importance">Variable importance<a class="anchor" aria-label="anchor" href="#variable-importance"></a>
</h3>
<p>Which variables are particularly relevant for the model? This aspect
is helpful in different ways. Firstly, it might help to simplify the
full modelling process by eliminating difficult to assess input
variables with low explanatory power. Secondly, its pure information.
Thirdly, it might help to identify problems in data structure: if one
variable is extremely relevant and all others are not, then there might
be some sort of information leakage from the response. Finally, variable
importance considerations are very relevant for quality assurance as
well.</p>
<p>Different modelling techniques offer different ways of variable
importance. In linear models, we consider for example F-test statistics
or p values, in tree-based methods the number of splits or average split
gains etc. A model agnostic way to assess this is called <em>permutation
importance</em>: For each input variable <span class="math inline">\(X\)</span>, its values are randomly shuffled and
the drop in performance with respect to a scoring function is
calculated. The more important a variable, the larger the drop. If a
variable can be shuffled without any impact on model precision, it is
completely irrelevant. The method is described in <span class="citation">(<a href="#ref-fisher" role="doc-biblioref">Fisher,
Rudin, and Dominici 2018</a>)</span>. Multiple permutations lead to more
stable estimates of variable importance and allow the calculation of
standard errors.</p>
</div>
<div class="section level3">
<h3 id="effects-of-input-variables">Effects of input variables<a class="anchor" aria-label="anchor" href="#effects-of-input-variables"></a>
</h3>
<p>In linear regression, the fitted model consists of an affine linear
function in the inputs. Its coefficients immediately tell us how the
response is expected to change if the value of one single input variable
<span class="math inline">\(X\)</span> is systematically being adapted.
How to describe such effects of a variable <span class="math inline">\(X\)</span> for more complex models that include
non-linearities and high-order interactions?</p>
<p>One approach is to study <em>Individual Conditional Expectation
(ICE)</em> profiles of selected observations: They show how predictions
of observation <span class="math inline">\(i\)</span> react when the
input variable <span class="math inline">\(X\)</span> is systematically
being changed, see <span class="citation">(<a href="#ref-goldstein" role="doc-biblioref">Goldstein et al. 2015</a>)</span>. The more
different the profiles are in shape or slope, the stronger are the
interaction effects. For a linear regression without interactions, all
such profiles would be parallel. Centered ICE profiles (“c-ICE”) help to
detect interactions even better.</p>
<p>If many ICE profiles are averaged, we get <em>partial dependence
profiles</em> which can be viewed as the average effect of variable
<span class="math inline">\(X\)</span>, pooled over all interactions.
Partial dependence plots where introduced in Friedman’s seminal 2001
article on gradient boosting <span class="citation">(<a href="#ref-friedman2001" role="doc-biblioref">Friedman 2001</a>)</span>.
Partial dependence profiles (as well as ICE profiles) are not limited to
one single variable <span class="math inline">\(X\)</span>. Also
multiple variables can be systematically varied on a grid in order to
study the multivariate impact on the typical response.</p>
<p>Studying ICE and partial dependence profiles means investigating the
effect of <span class="math inline">\(X\)</span> while holding all other
predictors fixed. The more unnatural this Ceteris Paribus assumption is,
the less reasonable are the results of ICE and partial dependence.
<em>Accumulated local effects</em> or <em>ALE</em> profiles <span class="citation">(<a href="#ref-apley" role="doc-biblioref">Apley and
Zhu 2016</a>)</span> try to overcome this weakness of ICE and partial
dependence considerations.</p>
<p>ALE profiles at positions <span class="math inline">\(x_i\)</span>
are calculated as follows:</p>
<ol style="list-style-type: decimal">
<li><p>First, left derivatives <span class="math inline">\(\Delta_i\)</span> are estimated for all <span class="math inline">\(i\)</span>: Calculate slope of partial dependence
line from <span class="math inline">\(x_i-\varepsilon\)</span> to <span class="math inline">\(x\)</span> based on data points in <span class="math inline">\([x_i-\varepsilon, x_i]\)</span>.</p></li>
<li><p>The uncalibrated ALE value at <span class="math inline">\(x_i\)</span> is the (integrated/accumulated)
partial sum <span class="math inline">\(\sum_{j \le i}
\Delta_j\)</span>.</p></li>
<li><p>In the calibration step, the effects are shifted to the level of
the response variable or its predictions.</p></li>
</ol>
<p>An alternative to partial dependence and ALE profiles is to look at
combined effects of <span class="math inline">\(X\)</span> including the
effects from all other predictors. Such effects are estimated by
averaging the predictions within values of the predictor <span class="math inline">\(X\)</span> of interest. If such prediction profile
differs considerably from the observed average response, this might be a
sign of model underfit. This visualization is sometimes called “marginal
plot” or “M plot”, see <span class="citation">(<a href="#ref-apley" role="doc-biblioref">Apley and Zhu 2016</a>)</span>. Residual profiles
immediately show such misfits as well. In classical statistical
modelling, this sort of plots are called “fitted versus covariable”
plots or “residual versus covariable” plots.</p>
<p>If SHAP values have been calculated, plotting their average
contributions of <span class="math inline">\(X\)</span> against <span class="math inline">\(X\)</span> is an elegant way to visualize the
effect of <span class="math inline">\(X\)</span>, see Subsection
“Variable contribution breakdown for single observations”.</p>
<p>Besides looking at <em>average</em> profiles, it is often also
revealing to consider <em>quartiles</em> or to visualize partial
dependence, response and prediction profiles in the same plot.</p>
<p>Instead of studying profiles, it might be revealing to look at
scatter plots of responses, predictions, residuals, or SHAP values
versus <span class="math inline">\(X\)</span>.</p>
</div>
<div class="section level3">
<h3 id="interaction-strength">Interaction strength<a class="anchor" aria-label="anchor" href="#interaction-strength"></a>
</h3>
<p>Besides measuring overall variable importance, an interesting aspect
is to measure the strength of non-additivity associated with each
covariable (i.e. the overall interaction strength) and/or between pairs
of covariables. A model-agnostic way to assess such measures is based on
partial dependence curves, see <span class="citation">(<a href="#ref-friedman2008" role="doc-biblioref">Friedman and Popescu
2008</a>)</span>. A computationally less demanding alternative to their
H-statistic of measuring total interaction strength per covariable can
be extracted from centered ICE: How much of their variability is
unexplained by the main effect?</p>
</div>
<div class="section level3">
<h3 id="variable-contribution-breakdown-for-single-observations">Variable contribution breakdown for single observations<a class="anchor" aria-label="anchor" href="#variable-contribution-breakdown-for-single-observations"></a>
</h3>
<p>Instead of studying global variable importance and effects, there are
different techniques to entangle how a <em>single prediction</em> can be
explained: LIME, LIVE, SHAP and breakdown, see <span class="citation">(<a href="#ref-molnar" role="doc-biblioref">Molnar
2019</a>)</span> and <span class="citation">(<a href="#ref-gosiewska" role="doc-biblioref">Gosiewska and Biecek 2019</a>)</span> for an
overview. The <code>flashlight</code> package currently supports the
breakdown method as well as approximate SHAP. These two methods are
based on additive decomposition of a prediction.</p>
<p>The breakdown algorithm works as follows: First, the visit order
<span class="math inline">\((x_1, ..., x_m)\)</span> of variables is
specified. Then, in the query data, the column <span class="math inline">\(x_1\)</span> is set to the constant value of <span class="math inline">\(x_1\)</span> of the observation to be explained.
The change in the (weighted) average predicted value on the query data
measures the contribution of <span class="math inline">\(x_1\)</span> on
the prediction. This procedure is iterated over all <span class="math inline">\(x_i\)</span> until eventually, all rows in the
query data are identical to the observation to be explained.</p>
<p>A complication with this approach is that the visit order is
relevant, at least for non-additive models. Ideally, the algorithm could
be repeated for all <span class="math inline">\(m!\)</span> possible
visit orders and its results averaged per variable. This is what SHAP
does, see e.g. <span class="citation">(<a href="#ref-gosiewska" role="doc-biblioref">Gosiewska and Biecek 2019</a>)</span> for an
explanation. Unfortunately, there is no efficient way to do this in a
model agnostic way. Thus we offer two approximations. The first one is
the short-cut described in <span class="citation">(<a href="#ref-gosiewska" role="doc-biblioref">Gosiewska and Biecek
2019</a>)</span> and implemented in the <code>ibreakdown</code> package
(<a href="https://CRAN.R-project.org/package=iBreakDown" class="external-link uri">https://CRAN.R-project.org/package=iBreakDown</a>): There,
the variables <span class="math inline">\(x_i\)</span> are sorted by the
size of their contribution in the same way as the breakdown algorithm
but without iteration, i.e. starting from the original query data for
each variable <span class="math inline">\(x_i\)</span>. We call this
approach “breakdown”. The second, computationally more intensive way to
approximate SHAP values is based on running the breakdown algorithm on a
small number (e.g. 12) random permutations and then averaging the
results. We call this approach (approximate) “SHAP”.</p>
</div>
<div class="section level3">
<h3 id="global-surrogate-models">Global surrogate models<a class="anchor" aria-label="anchor" href="#global-surrogate-models"></a>
</h3>
<p>As suggested in <span class="citation">(<a href="#ref-molnar" role="doc-biblioref">Molnar 2019</a>)</span>, one way to explain a
complex model is to fit an easy to interprete model like a decision tree
to the <em>predictions of the complex model</em> and then study this
simple surrogate model. The quality of its approximation can be measured
by the R-squared of the surrogate model.</p>
</div>
<div class="section level3">
<h3 id="flashlight">flashlight<a class="anchor" aria-label="anchor" href="#flashlight"></a>
</h3>
<p>The <code>flashlight</code> package offers these tools in a very
simple way.</p>
</div>
</div>
<div class="section level2">
<h2 id="installation-of-flashlight">Installation of <code>flashlight</code><a class="anchor" aria-label="anchor" href="#installation-of-flashlight"></a>
</h2>
<p>From CRAN:</p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"flashlight"</span><span class="op">)</span></span></code></pre>
<p>Latest version from github:</p>
<pre><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span></span>
<span><span class="fu">install_github</span><span class="op">(</span><span class="st">"mayer79/flashlight"</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="teaser">Teaser<a class="anchor" aria-label="anchor" href="#teaser"></a>
</h2>
<p>Let’s start with an iris example. For simplicity, we do not split the
data into training and testing/validation sets.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit model</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make flashlight</span></span>
<span><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flashlight.html">flashlight</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">fit</span>, </span>
<span>  data <span class="op">=</span> <span class="va">iris</span>, </span>
<span>  y <span class="op">=</span> <span class="st">"Sepal.Length"</span>, </span>
<span>  label <span class="op">=</span> <span class="st">"ols"</span>,               </span>
<span>  metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rmse <span class="op">=</span> <span class="va">rmse</span>, `R-squared` <span class="op">=</span> <span class="va">r_squared</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Performance: rmse and R-squared</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_performance.html">light_performance</a></span><span class="op">(</span><span class="va">fl</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-1.png" width="528"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_performance.html">light_performance</a></span><span class="op">(</span><span class="va">fl</span>, by <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-2.png" width="528"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Variable importance by increase in rmse</span></span>
<span><span class="va">imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_importance.html">light_importance</a></span><span class="op">(</span><span class="va">fl</span>, m_repetitions <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">imp</span>, fill <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-3.png" width="528"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># ICE profiles for Petal.Width</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_ice.html">light_ice</a></span><span class="op">(</span><span class="va">fl</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-4.png" width="528"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_ice.html">light_ice</a></span><span class="op">(</span><span class="va">fl</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span>, center <span class="op">=</span> <span class="st">"first"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-5.png" width="528"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Partial dependence profiles for Petal.Width</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fl</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-6.png" width="528"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fl</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span>, by <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-7.png" width="528"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># 2D partial dependence</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_profile2d.html">light_profile2d</a></span><span class="op">(</span><span class="va">fl</span>, v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Petal.Width"</span>, <span class="st">"Petal.Length"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-8.png" width="528"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Accumulated local effects (ALE) profiles for Petal.Width</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fl</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span>, type <span class="op">=</span> <span class="st">"ale"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-9.png" width="528"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Prediction, response and residual profiles, e.g.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fl</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span>, type <span class="op">=</span> <span class="st">"residual"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-10.png" width="528"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># All in one...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_effects.html">light_effects</a></span><span class="op">(</span><span class="va">fl</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span><span class="op">)</span>, use <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-11.png" width="528"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Scatter plots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_scatter.html">light_scatter</a></span><span class="op">(</span><span class="va">fl</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span>, type <span class="op">=</span> <span class="st">"predicted"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-12.png" width="528"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Variable contribution breakdown for single observation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_breakdown.html">light_breakdown</a></span><span class="op">(</span><span class="va">fl</span>, new_obs <span class="op">=</span> <span class="va">iris</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-13.png" width="528"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Global surrogate</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_global_surrogate.html">light_global_surrogate</a></span><span class="op">(</span><span class="va">fl</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-2-14.png" width="528"></p>
</div>
<div class="section level2">
<h2 id="flashlights-and-multiflashlights">flashlights and multiflashlights<a class="anchor" aria-label="anchor" href="#flashlights-and-multiflashlights"></a>
</h2>
<p>The process of using the <code>flashlight</code> package is as
follows:</p>
<ol style="list-style-type: decimal">
<li>
<p>Define a flashlight object for each model. This is basically a
list with optional components relevant for model interpretation:</p>
<ul>
<li><p><code>model</code>: The fitted model object as the one returned
by <code>lm</code>.</p></li>
<li><p><code>data</code>: A data set used to evaluate model agnostic
tools, e.g. the validation data.</p></li>
<li><p><code>y</code>: The name of the variable in <code>data</code>
representing the model response.</p></li>
<li><p><code>predict_function</code>: A function taking
<code>model</code> and <code>data</code> and returning numeric
predictions.</p></li>
<li><p><code>linkinv</code>: Inverse link function used to retransform
the values returned by <code>predict_function</code>. Defaults to the
identity function <code>function(z) z</code>.</p></li>
<li><p><code>w</code>: The name of the variable in <code>data</code>
representing the case weights.</p></li>
<li><p><code>by</code>: A character vector of names of grouping
variables in <code>data</code>. These will be used to stratify all
results.</p></li>
<li><p><code>metrics</code>: A named list of metrics. These functions
need to be available in the workspace and require arguments
<code>actual</code>, <code>predicted</code>, <code>w</code> (case
weights) as well as a placeholder … for further arguments. All metrics
available in R package <code>MetricsWeighted</code> are
suitable.</p></li>
<li><p><code>label</code>: The name of the model as shown in plots. This
is the only required input when building the flashlight.</p></li>
</ul>
</li>
<li>
<p>Calculate relevant information by calling the key functions:</p>
<ul>
<li><p><code>light_performance</code>: Calculates performance measures
regarding different metrics, possibly within subgroups and weighted by
case weights.</p></li>
<li><p><code>light_importance</code>: Calculates variable importance
(worsening in performance by random shuffling) for each or a subset of
variables. Possibly within subgroups and using case weights. The most
important variable names can be extracted by the function
<code>most_important</code> on the result of
<code>light_importance</code>.</p></li>
<li><p><code>light_ice</code>: Calculates ICE profiles across a couple
of observations, possibly within groups.</p></li>
<li><p><code>light_scatter</code>: Calculates values (e.g. predictions)
to be plotted against a variable of interest.</p></li>
<li><p><code>light_profile</code>: Calculates partial dependence
profiles across a covariable, possibly within groups. Generated by
calling <code>light_ice</code> and aggregating the results. The function
is flexible: it can also be used to generate ALE, response, residual,
prediction, or SHAP profiles and calculate (weighted) quartiles instead
of (weighted) means.</p></li>
<li><p><code>light_profile2d</code>: Two-dimensional version of
<code>light_profile</code> (except for ALE).</p></li>
<li><p><code>light_effects</code>: Combines partial dependence, response
and prediction profiles. ALE profiles can be added as well.</p></li>
<li><p><code>light_interaction</code>: Calculates overall and pairwise
interaction strength based on Friedman’s H statistic.</p></li>
<li><p><code>light_breakdown</code>: Calculates variable contribution
breakdown (approximate SHAP) for a single observation.</p></li>
<li><p><code>light_global_surrogate</code>: Fits an easy to interprete
decision tree to the predictions of the model.</p></li>
</ul>
</li>
<li><p>Plot the result: Each of these functions offer a
<code>plot</code> method with minimal visualization of the results
through <code>ggplot2</code>. The resulting plot can be customized by
adding <code>theme</code> and other <code>ggplot</code> elements. If
customization is insufficient, you can extract the data slot in the
object returned by above key functions and build your own plot.</p></li>
</ol>
<p>In practice, multiple flashlights are being defined and evaluated in
parallel. By the help of a <code>multiflashlight</code> object, The
<code>flashlight</code> packages provides as much support as possible to
avoid any redundancy. It can combine fully specified flashlights or, and
that is the more interesting option, take minimally defined flashlights
(e.g. only <code>label</code>, <code>model</code> and
<code>predict_function</code>) and add common arguments like
<code>y</code>, <code>by</code>, <code>data</code> and/or <code>w</code>
(case weights) in calling <code>multiflashlight</code>. If necessary,
the resulting completed flashlights contained in the multiflashlight can
be extracted again by <code>$</code>.</p>
<p>All key functions are defined for both <code>flashlight</code> and
<code>multiflashlight</code> objects.</p>
</div>
<div class="section level2">
<h2 id="shap">SHAP<a class="anchor" aria-label="anchor" href="#shap"></a>
</h2>
<p>SHAP (see <span class="citation">(<a href="#ref-Lundberg2017" role="doc-biblioref">Scott M. Lundberg and Lee 2017</a>)</span>) offer a
very elegant way to summarize the additive contribution of each variable
to a single prediction, see . If such decompositions are available for
many predictions, they can also be used to study global properties of
the model such as variable importance (by averaging the absolute SHAP
values of each variable) or effects (by showing SHAP values per
variable). The problem with SHAP values is that they are computationally
too demanding to be computed in general. Only for certain model
techniques (e.g. tree based methods, see <span class="citation">(<a href="#ref-Lundberg2020" role="doc-biblioref">Scott M. Lundberg et al.
2020</a>)</span>), they can be computed exactly. Nevertheless,
approximations exist, see <span class="citation">(<a href="#ref-gosiewska" role="doc-biblioref">Gosiewska and Biecek
2019</a>)</span> for details. Unfortunately, even these approximations
take time to compute. The approach followed by <code>flashlight</code>
is to compute SHAP values once and store them in the
<code>flashlight</code> object. All available methods for SHAP values
will then use these values without recalculating them. Thus, if e.g. the
inverse link function is updated, this has no effect on calculated SHAP
values.</p>
<p>The workflow is as follows:</p>
<pre><code><span><span class="co"># Fit models</span></span>
<span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span></span>
<span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="va">Species</span><span class="op">:</span><span class="va">Petal.Length</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create multiflashlight</span></span>
<span><span class="va">fl1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flashlight.html">flashlight</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">fit1</span>, label <span class="op">=</span> <span class="st">"additive"</span><span class="op">)</span></span>
<span><span class="va">fl2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flashlight.html">flashlight</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">fit2</span>, label <span class="op">=</span> <span class="st">"non-additive"</span><span class="op">)</span></span>
<span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multiflashlight.html">multiflashlight</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fl1</span>, <span class="va">fl2</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">iris</span>, y <span class="op">=</span> <span class="st">"Sepal.Length"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add SHAP values</span></span>
<span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_shap.html">add_shap</a></span><span class="op">(</span><span class="va">fls</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use them in different methods</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_importance.html">light_importance</a></span><span class="op">(</span><span class="va">fls</span>, type <span class="op">=</span> <span class="st">"shap"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_scatter.html">light_scatter</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"Petal.Length"</span>, type <span class="op">=</span> <span class="st">"shap"</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_scatter.html">light_scatter</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"Petal.Length"</span>, type <span class="op">=</span> <span class="st">"shap"</span>, by <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"Petal.Length"</span>, type <span class="op">=</span> <span class="st">"shap"</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p>For larger data and/or slow prediction functions, even computing
approximate SHAP values might take too much time. The following options
in <code>add_shap</code> are available to reduce the running time:</p>
<ul>
<li><p>Reduce the number of variables (<code>v</code>).</p></li>
<li><p>Reduce the number of SHAP values (<code>n_shap</code>).</p></li>
<li><p>Reduce the size of the reference data set
(<code>n_max</code>).</p></li>
<li><p>Select <code>visit_strategy = "importance"</code> instead of
“permutation”.</p></li>
<li><p>If <code>visit_strategy = "permutation"</code>, reduce the number
of permutations (<code>n_perm</code>).</p></li>
<li><p>Avoid unnecessary flashlights in a multiflashlight.</p></li>
</ul>
<p>Once calculated, we suggest do store the resulting values. For a
single flashlight <code>x</code>, use
<code>saveRDS(x$shap), file = ...</code> resp.
<code>x$shap &lt;- readRDS(...)</code> to do so.</p>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>As illustration, we use the data set <code>house_prices</code> with
information on 21613 houses sold in King County between May 2014 and May
2015. It is shipped along with R package <code>moderndive</code>.</p>
<p>The first few observations look as follows:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">house_prices</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 21</span></span></span>
<span><span class="co">#&gt;   id         date         price bedrooms bathrooms sqft_living sqft_lot floors</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 7129300520 2014-10-13  <span style="text-decoration: underline;">221</span>900        3      1           <span style="text-decoration: underline;">1</span>180     <span style="text-decoration: underline;">5</span>650      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 6414100192 2014-12-09  <span style="text-decoration: underline;">538</span>000        3      2.25        <span style="text-decoration: underline;">2</span>570     <span style="text-decoration: underline;">7</span>242      2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 5631500400 2015-02-25  <span style="text-decoration: underline;">180</span>000        2      1            770    <span style="text-decoration: underline;">10</span>000      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2487200875 2014-12-09  <span style="text-decoration: underline;">604</span>000        4      3           <span style="text-decoration: underline;">1</span>960     <span style="text-decoration: underline;">5</span>000      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1954400510 2015-02-18  <span style="text-decoration: underline;">510</span>000        3      2           <span style="text-decoration: underline;">1</span>680     <span style="text-decoration: underline;">8</span>080      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 7237550310 2014-05-12 1<span style="text-decoration: underline;">225</span>000        4      4.5         <span style="text-decoration: underline;">5</span>420   <span style="text-decoration: underline;">101</span>930      1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 13 more variables: waterfront &lt;lgl&gt;, view &lt;int&gt;, condition &lt;fct&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   grade &lt;fct&gt;, sqft_above &lt;int&gt;, sqft_basement &lt;int&gt;, yr_built &lt;int&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   yr_renovated &lt;int&gt;, zipcode &lt;fct&gt;, lat &lt;dbl&gt;, long &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   sqft_living15 &lt;int&gt;, sqft_lot15 &lt;int&gt;</span></span></span></code></pre></div>
<p>Thus we have access to many relevant features like size, condition as
well as location of the objects. We want to use these variables to
predict the (log) house prices by the help of the following regression
techniques and shed some light on them:</p>
<ul>
<li><p>linear regression,</p></li>
<li><p>random forests, and</p></li>
<li><p>boosted trees.</p></li>
</ul>
<p>We use 70% of the data to calculate the models, 20% for evaluating
their performance and for explaining them. 10% we keep untouched.</p>
<div class="section level3">
<h3 id="data-preparation">Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h3>
<p>Let’s do some data preparation common for all models under
consideration.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>  <span class="va">house_prices</span>,</span>
<span>  log_price <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">price</span><span class="op">)</span>,</span>
<span>  grade <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">grade</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">'%Y'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  age <span class="op">=</span> <span class="va">year</span> <span class="op">-</span> <span class="va">yr_built</span>,</span>
<span>  year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,</span>
<span>  zipcode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">zipcode</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  waterfront <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">waterfront</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"no"</span>, <span class="st">"yes"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grade"</span>, <span class="st">"year"</span>, <span class="st">"age"</span>, <span class="st">"sqft_living"</span>, <span class="st">"sqft_lot"</span>, <span class="st">"zipcode"</span>,</span>
<span>       <span class="st">"condition"</span>, <span class="st">"waterfront"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="modelling">Modelling<a class="anchor" aria-label="anchor" href="#modelling"></a>
</h3>
<p>The random forest can directly work with this data structure.
However, for the linear model, we need a small function with additional
feature engineering. We log transform some input variables and
categorize the zipcode in large groups. Similarly, for XGBoost, such a
wrapper function turns non-numeric input variables to numeric. We will
make use of these functions for both data preparation and
prediction.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Data wrapper for the linear model</span></span>
<span><span class="va">prep_lm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sqrt_living <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">sqft_living</span><span class="op">)</span>,</span>
<span>           sqrt_lot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">sqft_lot</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Data wrapper for xgboost</span></span>
<span><span class="va">prep_xgb</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select_all.html" class="external-link">select_at</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_if</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Negate</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="va">as.integer</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then, we split the data and train our models.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Train / valid / test split (70% / 20% / 10%)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">56745</span><span class="op">)</span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">prep</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train</span> <span class="op">&lt;-</span> <span class="va">prep</span><span class="op">[</span><span class="va">ind</span> <span class="op">&gt;=</span> <span class="fl">4</span>, <span class="op">]</span></span>
<span><span class="va">valid</span> <span class="op">&lt;-</span> <span class="va">prep</span><span class="op">[</span><span class="va">ind</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span></span>
<span><span class="va">test</span> <span class="op">&lt;-</span> <span class="va">prep</span><span class="op">[</span><span class="va">ind</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span></span>
<span></span>
<span><span class="op">(</span><span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/delete.response.html" class="external-link">reformulate</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"log_price"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; log_price ~ grade + year + age + sqft_living + sqft_lot + zipcode + </span></span>
<span><span class="co">#&gt;     condition + waterfront</span></span>
<span><span class="va">fit_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.formula.html" class="external-link">update.formula</a></span><span class="op">(</span><span class="va">form</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">sqft_living</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             data <span class="op">=</span> <span class="fu">prep_lm</span><span class="op">(</span><span class="va">train</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Random forest</span></span>
<span><span class="va">fit_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html" class="external-link">ranger</a></span><span class="op">(</span><span class="va">form</span>, data <span class="op">=</span> <span class="va">train</span>, respect.unordered.factors <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                 num.trees <span class="op">=</span> <span class="fl">100</span>, seed <span class="op">=</span> <span class="fl">8373</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"R-squared OOB:"</span>, <span class="va">fit_rf</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span><span class="co">#&gt; R-squared OOB: 0.8654302</span></span>
<span></span>
<span><span class="co"># Gradient boosting</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">has_xgb</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dtrain</span> <span class="op">&lt;-</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html" class="external-link">xgb.DMatrix</a></span><span class="op">(</span><span class="fu">prep_xgb</span><span class="op">(</span><span class="va">train</span>, <span class="va">x</span><span class="op">)</span>, </span>
<span>                                 label <span class="op">=</span> <span class="va">train</span><span class="op">[[</span><span class="st">"log_price"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">dvalid</span> <span class="op">&lt;-</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html" class="external-link">xgb.DMatrix</a></span><span class="op">(</span><span class="fu">prep_xgb</span><span class="op">(</span><span class="va">valid</span>, <span class="va">x</span><span class="op">)</span>, </span>
<span>                                 label <span class="op">=</span> <span class="va">valid</span><span class="op">[[</span><span class="st">"log_price"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>                 max_depth <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                 alpha <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                 lambda <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                 colsample_bytree <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fit_xgb</span> <span class="op">&lt;-</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html" class="external-link">xgb.train</a></span><span class="op">(</span></span>
<span>    <span class="va">params</span>,</span>
<span>    data <span class="op">=</span> <span class="va">dtrain</span>,</span>
<span>    watchlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>train <span class="op">=</span> <span class="va">dtrain</span>, valid <span class="op">=</span> <span class="va">dvalid</span><span class="op">)</span>,</span>
<span>    nrounds <span class="op">=</span> <span class="fl">250</span>,</span>
<span>    print_every_n <span class="op">=</span> <span class="fl">25</span>,</span>
<span>    objective <span class="op">=</span> <span class="st">"reg:squarederror"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">fit_xgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html" class="external-link">rpart</a></span><span class="op">(</span><span class="va">form</span>, data <span class="op">=</span> <span class="va">train</span>, </span>
<span>                   control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>xval <span class="op">=</span> <span class="fl">0</span>, cp <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, minsplit <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">prep_xgb</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">data</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1]  train-rmse:10.048228    valid-rmse:10.056726 </span></span>
<span><span class="co">#&gt; [26] train-rmse:0.240650 valid-rmse:0.249891 </span></span>
<span><span class="co">#&gt; [51] train-rmse:0.192509 valid-rmse:0.206319 </span></span>
<span><span class="co">#&gt; [76] train-rmse:0.177283 valid-rmse:0.194977 </span></span>
<span><span class="co">#&gt; [101]    train-rmse:0.168919 valid-rmse:0.189889 </span></span>
<span><span class="co">#&gt; [126]    train-rmse:0.162852 valid-rmse:0.186460 </span></span>
<span><span class="co">#&gt; [151]    train-rmse:0.158596 valid-rmse:0.184813 </span></span>
<span><span class="co">#&gt; [176]    train-rmse:0.155000 valid-rmse:0.183459 </span></span>
<span><span class="co">#&gt; [201]    train-rmse:0.151888 valid-rmse:0.182982 </span></span>
<span><span class="co">#&gt; [226]    train-rmse:0.149310 valid-rmse:0.182545 </span></span>
<span><span class="co">#&gt; [250]    train-rmse:0.147153 valid-rmse:0.182574</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="creating-the-flashlights">Creating the flashlights<a class="anchor" aria-label="anchor" href="#creating-the-flashlights"></a>
</h3>
<p>Let’s initialize one flashlight per model. Thanks to individual
prediction functions, any model can be used in <code>flashlight</code>,
even keras models.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fl_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flashlight.html">flashlight</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">train</span><span class="op">$</span><span class="va">log_price</span><span class="op">)</span>, </span>
<span>  label <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  predict_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod</span>, <span class="va">X</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">mod</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fl_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flashlight.html">flashlight</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">fit_lm</span>, </span>
<span>  label <span class="op">=</span> <span class="st">"lm"</span>,</span>
<span>  predict_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod</span>, <span class="va">X</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, <span class="fu">prep_lm</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fl_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flashlight.html">flashlight</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">fit_rf</span>, </span>
<span>  label <span class="op">=</span> <span class="st">"rf"</span>,</span>
<span>  predict_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod</span>, <span class="va">X</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, <span class="va">X</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fl_xgb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flashlight.html">flashlight</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">fit_xgb</span>, </span>
<span>  label <span class="op">=</span> <span class="st">"xgb"</span>,</span>
<span>  predict_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod</span>, <span class="va">X</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, <span class="fu">prep_xgb</span><span class="op">(</span><span class="va">X</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fl_xgb</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Flashlight xgb </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model:            Yes</span></span>
<span><span class="co">#&gt; y:            No</span></span>
<span><span class="co">#&gt; w:            No</span></span>
<span><span class="co">#&gt; by:           No</span></span>
<span><span class="co">#&gt; data dim:         No</span></span>
<span><span class="co">#&gt; predict_fct default:  FALSE</span></span>
<span><span class="co">#&gt; linkinv default:  FALSE</span></span>
<span><span class="co">#&gt; metrics:      rmse</span></span>
<span><span class="co">#&gt; SHAP:             No</span></span></code></pre></div>
<p>What about all other relevant elements of a flashlight like the
underlying data, the response name, metrics, retransformation functions
etc? We could pass them to each of our flashlights. Or better, we can
combine the flashlights to a multiflashlight and pass additional common
arguments there.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multiflashlight.html">multiflashlight</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fl_mean</span>, <span class="va">fl_lm</span>, <span class="va">fl_rf</span>, <span class="va">fl_xgb</span><span class="op">)</span>, </span>
<span>  y <span class="op">=</span> <span class="st">"log_price"</span>, </span>
<span>  linkinv <span class="op">=</span> <span class="va">exp</span>,</span>
<span>  data <span class="op">=</span> <span class="va">valid</span>, </span>
<span>  metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rmse <span class="op">=</span> <span class="va">rmse</span>, `R-squared` <span class="op">=</span> <span class="va">r_squared</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We could even extract these completed flashlights from the
multiflashlight as if the latter is a list (actually it <em>is</em> a
list with additional class <code>multiflashlight</code>).</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fl_lm</span> <span class="op">&lt;-</span> <span class="va">fls</span><span class="op">$</span><span class="va">lm</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="assess-performance">Assess performance<a class="anchor" aria-label="anchor" href="#assess-performance"></a>
</h3>
<p>Let’s compare the models regarding their validation performance.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">perf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_performance.html">light_performance</a></span><span class="op">(</span><span class="va">fls</span><span class="op">)</span></span>
<span><span class="va">perf</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; I am an object of class light_performance_multi </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data.frames:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  data </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8 × 3</span></span></span>
<span><span class="co">#&gt;   label metric        value</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> mean  rmse       0.527   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> mean  R-squared -<span style="color: #BB0000;">0.000</span><span style="color: #BB0000; text-decoration: underline;">267</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> lm    rmse       0.188   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> lm    R-squared  0.872   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> rf    rmse       0.192   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> rf    R-squared  0.868   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> xgb   rmse       0.183   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> xgb   R-squared  0.880</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">perf</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-10-1.png" width="528"></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">perf</span>, fill <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-11-1.png" width="528"></p>
<p>The plot “politics” of <code>flashlight</code> is to provide simple
graphics with minimal <code>ggplot</code>-tuning, so you are able to add
your own modifications. If you are completely unhappy about the proposed
plot (e.g. rather favour a scatterplot over a barplot), extract the
<code>data</code> slot of <code>perf</code> and create the figure from
scratch:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">perf</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">#&gt;   label metric        value</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> mean  rmse       0.527   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> mean  R-squared -<span style="color: #BB0000;">0.000</span><span style="color: #BB0000; text-decoration: underline;">267</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> lm    rmse       0.188   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> lm    R-squared  0.872   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> rf    rmse       0.192   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> rf    R-squared  0.868</span></span>
<span></span>
<span><span class="va">perf</span><span class="op">$</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">label</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">metric</span>, color <span class="op">=</span> <span class="va">metric</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-12-1.png" width="528"></p>
<p>The same logic holds for all other main functions in the
<code>flashlight</code> package.</p>
<p>For performance considerations, the minimum required info in the
(multi-)flashlight are: “y”, “predict_function”, “model”, “data” and
“metrics”. The latter two can also be passed on the fly.</p>
</div>
<div class="section level3">
<h3 id="variable-importance-1">Variable importance<a class="anchor" aria-label="anchor" href="#variable-importance-1"></a>
</h3>
<p>Now let’s study variable importance of the explainers.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_importance.html">light_importance</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; I am an object of class light_importance_multi </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data.frames:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  data </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 32 × 5</span></span></span>
<span><span class="co">#&gt;    label metric variable      value error</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> mean  rmse   grade       0       <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> mean  rmse   year        0       <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> mean  rmse   age         0       <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> mean  rmse   sqft_living 0       <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> mean  rmse   sqft_lot    0       <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> mean  rmse   zipcode     0       <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> mean  rmse   condition   0       <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> mean  rmse   waterfront  0       <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> lm    rmse   grade       0.082<span style="text-decoration: underline;">8</span>  <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> lm    rmse   year        0.001<span style="text-decoration: underline;">87</span> <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 22 more rows</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">imp</span>, fill <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-13-1.png" width="528"></p>
<p>Note for permutation importance: If the calculation takes too long
(e.g. large query data), set <code>n_max</code> to some reasonable
value. <code>light_importance</code> will then randomly pick
<code>n_max</code> rows and use only these for assessment of importance.
On the other hand, if the calculations is very fast, consider setting
<code>m_repetitions</code> to a value &gt; 1 in order to repeat the
permutations multiple times. The resulting variable importance
corresponds to the average drop in performance and standard errors are
added.</p>
<p>If SHAP values have been precomputed by <code>add_shap</code>, use
<code>type = "shap"</code> to show mean absolute shap values per
covariable.</p>
</div>
<div class="section level3">
<h3 id="individual-conditional-expectation">Individual conditional expectation<a class="anchor" aria-label="anchor" href="#individual-conditional-expectation"></a>
</h3>
<p>How do predictions change when <code>sqft_living</code> changes
alone? We can investigate this question by looking at “Individual
Conditional Expectation” (ICE) profiles of a couple of observations.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_ice.html">light_ice</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, n_max <span class="op">=</span> <span class="fl">30</span>, seed <span class="op">=</span> <span class="fl">35</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cp</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-14-1.png" width="528"></p>
<p>Note: Setting <code>seed</code> to a fixed value will ensure that the
flashlights will consider the same rows. An alternative would be to pass
a small subset of the data to <code>light_ice</code> and calculate all
profiles or by passing row indices through <code>indices</code> for
fixed selection.</p>
<p>Centered ICE profiles (“c-ICE”) can help to increase visibility of
interactions.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_ice.html">light_ice</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, n_max <span class="op">=</span> <span class="fl">30</span>, seed <span class="op">=</span> <span class="fl">35</span>, center <span class="op">=</span> <span class="st">"first"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cp</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-15-1.png" width="528"></p>
</div>
<div class="section level3">
<h3 id="partial-dependence-profiles">Partial dependence profiles<a class="anchor" aria-label="anchor" href="#partial-dependence-profiles"></a>
</h3>
<p>If many ICE profiles (in our case 1000) are averaged, we get an
impression on the average effect of the considered variable. Such curves
are called <em>partial dependence profiles</em> (PD) resp. <em>partial
dependence plots</em>.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span><span class="op">)</span></span>
<span><span class="va">pd</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; I am an object of class light_profile_multi </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data.frames:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  data </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 40 × 5</span></span></span>
<span><span class="co">#&gt;    sqft_living counts   value label type              </span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>         500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  partial dependence</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>        <span style="text-decoration: underline;">1</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  partial dependence</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>        <span style="text-decoration: underline;">2</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  partial dependence</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>        <span style="text-decoration: underline;">3</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  partial dependence</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>        <span style="text-decoration: underline;">4</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  partial dependence</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>        <span style="text-decoration: underline;">5</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  partial dependence</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>        <span style="text-decoration: underline;">6</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  partial dependence</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>        <span style="text-decoration: underline;">7</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  partial dependence</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>        <span style="text-decoration: underline;">8</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  partial dependence</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>        <span style="text-decoration: underline;">9</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  partial dependence</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 30 more rows</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pd</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-16-1.png" width="528"></p>
<p>The <code>light_profile</code> function offers different ways to
specify the evaluation points of the profiles. One option is to
explicitly pass such points.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, </span>
<span>                    pd_evaluate_at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">4000</span>, by <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pd</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-17-1.png" width="528"></p>
<p>Two-dimensional:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_profile2d.html">light_profile2d</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"condition"</span>, <span class="st">"grade"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pd</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-18-1.png" width="528"></p>
</div>
<div class="section level3">
<h3 id="accumulated-local-effects-ale">Accumulated local effects (ALE)<a class="anchor" aria-label="anchor" href="#accumulated-local-effects-ale"></a>
</h3>
<p>An approximation of main effects without Ceteris Paribus clause are
<em>accumulated local effects</em> profiles <span class="citation">(<a href="#ref-fisher" role="doc-biblioref">Fisher, Rudin, and Dominici
2018</a>)</span>. They are based on accumulating local partial
dependence slopes.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ale</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, type <span class="op">=</span> <span class="st">"ale"</span><span class="op">)</span></span>
<span><span class="va">ale</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; I am an object of class light_profile_multi </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; data.frames:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  data </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 32 × 5</span></span></span>
<span><span class="co">#&gt;    sqft_living counts   value label type </span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>        <span style="text-decoration: underline;">1</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  ale  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>        <span style="text-decoration: underline;">2</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">462</span>845. mean  ale  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>        <span style="text-decoration: underline;">3</span>500    859 <span style="text-decoration: underline;">462</span>845. mean  ale  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>        <span style="text-decoration: underline;">4</span>500    231 <span style="text-decoration: underline;">462</span>845. mean  ale  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>        <span style="text-decoration: underline;">5</span>500     52 <span style="text-decoration: underline;">462</span>845. mean  ale  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>        <span style="text-decoration: underline;">6</span>500     16 <span style="text-decoration: underline;">462</span>845. mean  ale  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>        <span style="text-decoration: underline;">7</span>500      9 <span style="text-decoration: underline;">462</span>845. mean  ale  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>        <span style="text-decoration: underline;">8</span>500      5 <span style="text-decoration: underline;">462</span>845. mean  ale  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>        <span style="text-decoration: underline;">1</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">360</span>940. lm    ale  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>        <span style="text-decoration: underline;">2</span>500   <span style="text-decoration: underline;">1</span>000 <span style="text-decoration: underline;">483</span>272. lm    ale  </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 22 more rows</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ale</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-19-1.png" width="528">
Note: While equally sized x-breaks are easy to read, quantile binning
usually leads to more stable results.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, type <span class="op">=</span> <span class="st">"ale"</span>, cut_type <span class="op">=</span> <span class="st">"quantile"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-20-1.png" width="528"></p>
<p>In order to calculate ICEs, PDs and ALEs, the following elements need
to be available in the (multi-)flashlight: “predict_function”, “model”,
“linkinv” and “data”. “data” can also be passed on the fly.</p>
</div>
<div class="section level3">
<h3 id="profiles-of-predicted-values-residuals-and-response">Profiles of predicted values, residuals, and response<a class="anchor" aria-label="anchor" href="#profiles-of-predicted-values-residuals-and-response"></a>
</h3>
<p>We can use the function <code>light_profile</code> not only to create
partial dependence profiles but also to get profiles of predicted values
(“M plots”), responses or residuals. Additionally, we can either use
averages or quartiles as summary statistics.</p>
<p>Average predicted values versus the living area are as follows:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">format_y</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">x</span>, big.mark <span class="op">=</span> <span class="st">"'"</span>, scientific <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pvp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, type <span class="op">=</span> <span class="st">"predicted"</span>, </span>
<span>                     format <span class="op">=</span> <span class="st">"fg"</span>, big.mark <span class="op">=</span> <span class="st">"'"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pvp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">format_y</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-21-1.png" width="528"></p>
<p>Note the formatting of y values as well as the <code>formatC</code>
option <code>format = "fg"</code> and <code>big.mark</code> passed to
the constructor of the x labels in order to improve basic appearance. We
will recycle some of these settings for the next plots.</p>
<p>Similarly, the average response profiles (identical for all
flashlights, to we only show one of them):</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rvp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fl_lm</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, type <span class="op">=</span> <span class="st">"response"</span>, format <span class="op">=</span> <span class="st">"fg"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rvp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">format_y</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-22-1.png" width="528"></p>
<p>Same, but quartiles:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rvp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fl_lm</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>                     stats <span class="op">=</span> <span class="st">"quartiles"</span>, format <span class="op">=</span> <span class="st">"fg"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rvp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">format_y</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-23-1.png" width="528"></p>
<p>What about residuals? First, we remove the “mean” flashlight by
setting it NULL.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fls</span><span class="op">$</span><span class="va">mean</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">rvp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, type <span class="op">=</span> <span class="st">"residual"</span>,</span>
<span>                     stats <span class="op">=</span> <span class="st">"quartiles"</span>, format <span class="op">=</span> <span class="st">"fg"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rvp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">format_y</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-24-1.png" width="528"></p>
<p>While the tree-based models have smaller residuals and medians close
to 0, the linear model shows residual curvature that could be captured
by representing <code>sqft_living</code> by more parameters.</p>
<p>If your are unhappy about the “group by” strategy, set
<code>swap_dim</code> to TRUE.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rvp</span>, swap_dim <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">format_y</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-25-1.png" width="528"></p>
<p>For less bars, set <code>n_bins</code> in
<code>light_profile</code>:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rvp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, type <span class="op">=</span> <span class="st">"residual"</span>,</span>
<span>                     stats <span class="op">=</span> <span class="st">"quartiles"</span>, format <span class="op">=</span> <span class="st">"fg"</span>, n_bins <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rvp</span>, swap_dim <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">format_y</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-26-1.png" width="528"></p>
<p>Just as diverging ICE profiles give you a clou about the presence of
interactions, we can use the option <code>stats = "quartiles"</code>
(with <code>pd_center</code>) to show divergence of the mean-centered
ICE profiles as boxes (predictions at log-scale to suppress
interaction-like effects of the retransformation function):</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rvp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, use_linkinv <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                     stats <span class="op">=</span> <span class="st">"quartiles"</span>, pd_center <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rvp</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-27-1.png" width="528"></p>
<p>For prediction profiles, the same elements as for ICE/PDs are
required, while for response profiles we need “y”, “linkinv” and “data”.
“data” can also be passed on the fly.</p>
</div>
<div class="section level3">
<h3 id="visualizing-different-types-of-profiles-as-effects-plot">Visualizing different types of profiles as “effects” plot<a class="anchor" aria-label="anchor" href="#visualizing-different-types-of-profiles-as-effects-plot"></a>
</h3>
<p>In assessing the model quality, it is often useful to visualize</p>
<ul>
<li><p>response profile (quartiles or means),</p></li>
<li><p>average predictions, and</p></li>
<li><p>model effects (partial dependence profiles, or accumulated local
effects)</p></li>
</ul>
<p>in the same plot and for each input variable. The
<code>flashlight</code> package offers the function
<code>light_effects</code> to combine such profile plots:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_effects.html">light_effects</a></span><span class="op">(</span><span class="va">fl_lm</span>, v <span class="op">=</span> <span class="st">"condition"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eff</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">format_y</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-28-1.png" width="528"></p>
<p>Let’s add counts to see if the gaps between response and predicted
profiles are problematic or just due to small samples.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_counts.html">plot_counts</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">eff</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-29-1.png" width="528"></p>
<p>The biggest gaps occur at very rare conditions, so the model looks
quite fine.</p>
<p>Note: Due to retransformation from log scale, the response profile is
slightly higher than the profile of predicted values. If we would
evaluate on the modelled log scale, that gap would vanish.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_effects.html">light_effects</a></span><span class="op">(</span><span class="fu"><a href="../reference/flashlight.html">flashlight</a></span><span class="op">(</span><span class="va">fl_lm</span>, linkinv <span class="op">=</span> <span class="va">I</span><span class="op">)</span>, v <span class="op">=</span> <span class="st">"condition"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eff</span>, use <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">format_y</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Effects plot on modelled log scale"</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-30-1.png" width="528"></p>
<p>Besides adding counts to the figure, representing observed responses
as boxplots (no whiskers and outliers in order to avoid too large y
scale) might help to judge if there is a problematic misfit.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_effects.html">light_effects</a></span><span class="op">(</span><span class="va">fl_lm</span>, v <span class="op">=</span> <span class="st">"condition"</span>, stats <span class="op">=</span> <span class="st">"quartiles"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eff</span>, rotate_x <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">format_y</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_counts.html">plot_counts</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">eff</span>, fill <span class="op">=</span> <span class="st">"blue"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span>, width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-31-1.png" width="528"></p>
<p>The <code>plot</code> method of <code>light_effects</code> allows to
hide certain plot elements if it looks too dense. If we would e.g. want
to compare partial dependence and accumulated local effects plots, we
can use the following approach.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_effects.html">light_effects</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, v_labels <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                     cut_type <span class="op">=</span> <span class="st">"quantile"</span>, n_bins <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eff</span>, use <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pd"</span>, <span class="st">"ale"</span><span class="op">)</span>, show_points <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">format_y</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">4000</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3e5</span>, <span class="fl">9e5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-32-1.png" width="528"></p>
<p>As an alternative to profile plots, we could also consider scatter
plots.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_scatter.html">light_scatter</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, n_max <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pr</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-33-1.png" width="528"></p>
</div>
<div class="section level3">
<h3 id="interaction-strength-1">Interaction strength<a class="anchor" aria-label="anchor" href="#interaction-strength-1"></a>
</h3>
<p>Based on Friedman’s H statistic <span class="citation">(<a href="#ref-friedman2008" role="doc-biblioref">Friedman and Popescu
2008</a>)</span>, we can investigate which variable has strongest
interaction effect relative to its full effect.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_interaction.html">light_interaction</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="va">x</span>, grid_size <span class="op">=</span> <span class="fl">30</span>, n_max <span class="op">=</span> <span class="fl">50</span>, seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">st</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-34-1.png" width="528">
Since we have not used interaction terms in the linear model, all values
are zero there.</p>
<p>Pairwise interactions are expensive to compute as each variable pair
has to be assessed. We limit the search for interactions to the four
variables with highest relative interaction strength.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_pair</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_interaction.html">light_interaction</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="fu"><a href="../reference/most_important.html">most_important</a></span><span class="op">(</span><span class="va">st</span>, <span class="fl">4</span><span class="op">)</span>, </span>
<span>                             pairwise <span class="op">=</span> <span class="cn">TRUE</span>, n_max <span class="op">=</span> <span class="fl">50</span>, seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">st_pair</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-35-1.png" width="528"></p>
</div>
<div class="section level3">
<h3 id="variable-contribution-breakdown-for-single-observation">Variable contribution breakdown for single observation<a class="anchor" aria-label="anchor" href="#variable-contribution-breakdown-for-single-observation"></a>
</h3>
<p>Besides investigating global effects, we can use
<code>light_breakdown</code> to calculate variable impact on one single
(log) prediction.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_breakdown.html">light_breakdown</a></span><span class="op">(</span><span class="va">fl_lm</span>, new_obs <span class="op">=</span> <span class="va">valid</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, </span>
<span>                      v <span class="op">=</span> <span class="va">x</span>, n_max <span class="op">=</span> <span class="fl">1000</span>, seed <span class="op">=</span> <span class="fl">74</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bd</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-36-1.png" width="528">
We have set the size of the reference data set to
<code>n_max = 1000</code> in order to save time. The only variable with
positive impact on the prediction is “age”. The other variables have a
negative impact compared to the 1000 reference observations.</p>
</div>
<div class="section level3">
<h3 id="global-surrogate-trees">Global surrogate trees<a class="anchor" aria-label="anchor" href="#global-surrogate-trees"></a>
</h3>
<p>A very different, but intuitive approach is to fit the original
predictions of the models by simple decision trees and then visualize
these trees.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_global_surrogate.html">light_global_surrogate</a></span><span class="op">(</span><span class="va">fls</span><span class="op">$</span><span class="va">xgb</span>, v <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">surr</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">r_squared</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.698482</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">surr</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-37-1.png" width="528"></p>
<p>Even if it is extremely simple to explain, the surrogate model is not
a bad approximation (see R-squared).</p>
</div>
</div>
<div class="section level2">
<h2 id="grouped-calculations">Grouped calculations<a class="anchor" aria-label="anchor" href="#grouped-calculations"></a>
</h2>
<p>A key feature of the <code>flashlight</code> package is to support
grouped results. You can initialize the (multi-)flashlight with column
names of one or many grouping variables or ask for grouped calculations
in all major <code>flashlight</code> functions. Plots are adapted
accordingly.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multiflashlight.html">multiflashlight</a></span><span class="op">(</span><span class="va">fls</span>, by <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Performance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_performance.html">light_performance</a></span><span class="op">(</span><span class="va">fls</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-38-1.png" width="528"></p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># With swapped dimension</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_performance.html">light_performance</a></span><span class="op">(</span><span class="va">fls</span><span class="op">)</span>, swap_dim <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-38-2.png" width="528"></p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Importance</span></span>
<span><span class="va">imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/light_importance.html">light_importance</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">imp</span>, top_m <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-38-3.png" width="528"></p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">imp</span>, swap_dim <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-38-4.png" width="528"></p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Effects: ICE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_ice.html">light_ice</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span>, seed <span class="op">=</span> <span class="fl">4345</span><span class="op">)</span>,</span>
<span>     alpha <span class="op">=</span> <span class="fl">0.8</span>, facet_scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">format_y</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-38-5.png" width="528"></p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Effects: Partial dependence</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-38-6.png" width="528"></p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"sqft_living"</span><span class="op">)</span>, swap_dim <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-38-7.png" width="528"></p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Global surrogate</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_global_surrogate.html">light_global_surrogate</a></span><span class="op">(</span><span class="va">fls</span><span class="op">$</span><span class="va">xgb</span>, v <span class="op">=</span> <span class="va">x</span>, maxdepth <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-38-8.png" width="528"></p>
</div>
<div class="section level2">
<h2 id="working-with-case-weights">Working with case weights<a class="anchor" aria-label="anchor" href="#working-with-case-weights"></a>
</h2>
<p>In many applications, case weights need to be taken into account. All
main functions in <code>flashlight</code> are able to deal with them.
The only thing you need to do is to pass the column name of the case
weights to <code>w</code> when initializing the (multi-)flashlight.</p>
<p>Let’s go through the initial iris example again with (artificial)
case weights:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add weight info to the flashlight</span></span>
<span><span class="va">fl_weighted</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flashlight.html">flashlight</a></span><span class="op">(</span><span class="va">fl</span>, w <span class="op">=</span> <span class="st">"Petal.Length"</span>, label <span class="op">=</span> <span class="st">"ols weighted"</span><span class="op">)</span></span>
<span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multiflashlight.html">multiflashlight</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fl</span>, <span class="va">fl_weighted</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Performance: rmse and R-squared</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_performance.html">light_performance</a></span><span class="op">(</span><span class="va">fls</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-39-1.png" width="528"></p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_performance.html">light_performance</a></span><span class="op">(</span><span class="va">fls</span>, by <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-39-2.png" width="528"></p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Variable importance by drop in rmse</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_importance.html">light_importance</a></span><span class="op">(</span><span class="va">fls</span>, by <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-39-3.png" width="528"></p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Partial dependence profiles for Petal.Width</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-39-4.png" width="528"></p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_profile.html">light_profile</a></span><span class="op">(</span><span class="va">fls</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span>, by <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-39-5.png" width="528"></p>
</div>
<div class="section level2">
<h2 id="binary-classification">Binary classification<a class="anchor" aria-label="anchor" href="#binary-classification"></a>
</h2>
<p>The <code>flashlight</code> package works for numeric responses
including binary targets. Multiclassification can only be handled by
defining a flashlight for each category and combining them to a
multiflashlight. For large data, this is inefficient.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ir</span> <span class="op">&lt;-</span> <span class="va">iris</span></span>
<span><span class="va">ir</span><span class="op">$</span><span class="va">virginica</span> <span class="op">&lt;-</span> <span class="va">ir</span><span class="op">$</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"virginica"</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">virginica</span> <span class="op">~</span> <span class="va">Sepal.Length</span> <span class="op">+</span> <span class="va">Petal.Width</span>, data <span class="op">=</span> <span class="va">ir</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make flashlight - need to select reasonable metrics</span></span>
<span><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flashlight.html">flashlight</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">fit</span>, </span>
<span>  data <span class="op">=</span> <span class="va">ir</span>, </span>
<span>  y <span class="op">=</span> <span class="st">"virginica"</span>, </span>
<span>  label <span class="op">=</span> <span class="st">"lr"</span>,</span>
<span>  metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>logLoss <span class="op">=</span> <span class="va">logLoss</span>, AUC <span class="op">=</span> <span class="va">AUC</span><span class="op">)</span>,</span>
<span>  predict_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span>, <span class="va">d</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">d</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Performance: rmse and R-squared</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_performance.html">light_performance</a></span><span class="op">(</span><span class="va">fl</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-40-1.png" width="528"></p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Variable importance by drop in rmse</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_importance.html">light_importance</a></span><span class="op">(</span><span class="va">fl</span>, v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sepal.Length"</span>, <span class="st">"Petal.Width"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>     fill <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-40-2.png" width="528"></p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># ICE profiles for Petal.Width</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/light_ice.html">light_ice</a></span><span class="op">(</span><span class="va">fl</span>, v <span class="op">=</span> <span class="st">"Petal.Width"</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span></code></pre></div>
<p><img src="p1_flashlight_files/figure-html/unnamed-chunk-40-3.png" width="528"></p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-apley" class="csl-entry">
Apley, Daniel W., and Jingyu Zhu. 2016. <span>“Visualizing the Effects
of Predictor Variables in Black Box Supervised Learning Models.”</span>
<a href="https://arxiv.org/abs/1612.08468" class="external-link">https://arxiv.org/abs/1612.08468</a>.
</div>
<div id="ref-fisher" class="csl-entry">
Fisher, Aaron, Cynthia Rudin, and Francesca Dominici. 2018. <span>“All
Models Are Wrong, but Many Are Useful: Learning a Variable’s Importance
by Studying an Entire Class of Prediction Models Simultaneously.”</span>
<a href="https://arxiv.org/abs/1801.01489" class="external-link">https://arxiv.org/abs/1801.01489</a>.
</div>
<div id="ref-friedman2001" class="csl-entry">
Friedman, Jerome H. 2001. <span>“Greedy Function Approximation: A
Gradient Boosting Machine.”</span> <em>Ann. Statist.</em> 29 (5):
1189–1232. <a href="https://doi.org/10.1214/aos/1013203451" class="external-link">https://doi.org/10.1214/aos/1013203451</a>.
</div>
<div id="ref-friedman2008" class="csl-entry">
Friedman, Jerome H., and Bogdan E. Popescu. 2008. <span>“Predictive
Learning via Rule Ensembles.”</span> <em>The Annals of Applied
Statistics</em> 2 (3): 916–54.
</div>
<div id="ref-goldstein" class="csl-entry">
Goldstein, Alex, Adam Kapelner, Justin Bleich, and Emil Pitkin. 2015.
<span>“Peeking Inside the Black Box: Visualizing Statistical Learning
with Plots of Individual Conditional Expectation.”</span> <em>Journal of
Computational and Graphical Statistics</em> 24 (1): 44–65. <a href="https://doi.org/10.1080/10618600.2014.907095" class="external-link">https://doi.org/10.1080/10618600.2014.907095</a>.
</div>
<div id="ref-gosiewska" class="csl-entry">
Gosiewska, Alicja, and Przemyslaw Biecek. 2019. <span>“Do Not Trust
Additive Explanations.”</span> <a href="https://arxiv.org/abs/1903.11420" class="external-link">https://arxiv.org/abs/1903.11420</a>.
</div>
<div id="ref-Lundberg2020" class="csl-entry">
Lundberg, Scott M., Gabriel Erion, Hugh Chen, Alex DeGrave, Jordan M.
Prutkin, Bala Nair, Ronit Katz, Jonathan Himmelfarb, Nisha Bansal, and
Su-In Lee. 2020. <span>“From Local Explanations to Global Understanding
with Explainable AI for Trees.”</span> <em>Nature Machine
Intelligence</em> 2 (1): 2522–5839.
</div>
<div id="ref-Lundberg2017" class="csl-entry">
Lundberg, Scott M, and Su-In Lee. 2017. <span>“A Unified Approach to
Interpreting Model Predictions.”</span> In <em>Advances in Neural
Information Processing Systems 30</em>, edited by I. Guyon, U. V.
Luxburg, S. Bengio, H. Wallach, R. Fergus, S. Vishwanathan, and R.
Garnett, 4765–74. Curran Associates, Inc. <a href="https://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predictions.pdf" class="external-link">https://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predictions.pdf</a>.
</div>
<div id="ref-molnar" class="csl-entry">
Molnar, Christoph. 2019. <em>Interpretable Machine Learning: A Guide for
Making Black Box Models Explainable</em>. <a href="https://christophm.github.io/interpretable-ml-book/" class="external-link">https://christophm.github.io/interpretable-ml-book/</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michael Mayer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
