<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using flashlight with h2o • flashlight</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using flashlight with h2o">
<meta property="og:description" content="flashlight">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flashlight</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.7.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/flashlight.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/flashlight_caret.html">Using flashlight with caret</a>
    </li>
    <li>
      <a href="../articles/flashlight_h2o.html">Using flashlight with h2o</a>
    </li>
    <li>
      <a href="../articles/flashlight_mlr3.html">Using flashlight with mlr3</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mayer79/flashlight/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using flashlight with h2o</h1>
                        <h4 class="author">Michael Mayer</h4>
            
            <h4 class="date">2020-04-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mayer79/flashlight/blob/master/../../vignettes/flashlight_h2o.Rmd"><code>../../vignettes/flashlight_h2o.Rmd</code></a></small>
      <div class="hidden name"><code>flashlight_h2o.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r">library(dplyr)
library(MetricsWeighted)
library(flashlight)
library(caret)
library(h2o)

h2o.init()
#&gt;  Connection successful!
#&gt; 
#&gt; R is connected to the H2O cluster: 
#&gt;     H2O cluster uptime:         57 minutes 28 seconds 
#&gt;     H2O cluster timezone:       Europe/Berlin 
#&gt;     H2O data parsing timezone:  UTC 
#&gt;     H2O cluster version:        3.28.0.4 
#&gt;     H2O cluster version age:    1 month and 26 days  
#&gt;     H2O cluster name:           H2O_started_from_R_Michael_koq104 
#&gt;     H2O cluster total nodes:    1 
#&gt;     H2O cluster total memory:   3.19 GB 
#&gt;     H2O cluster total cores:    8 
#&gt;     H2O cluster allowed cores:  8 
#&gt;     H2O cluster healthy:        TRUE 
#&gt;     H2O Connection ip:          localhost 
#&gt;     H2O Connection port:        54321 
#&gt;     H2O Connection proxy:       NA 
#&gt;     H2O Internal Security:      FALSE 
#&gt;     H2O API Extensions:         Amazon S3, Algos, AutoML, Core V3, TargetEncoder, Core V4 
#&gt;     R Version:                  R version 3.6.3 (2020-02-29)
h2o.no_progress()</pre></body></html></div>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This vignette shows how to use <code>flashlight</code> for interpretation of models trained with the <code>h2o</code> package.</p>
<p>Currently, the <strong>use of <code>flashlight</code> with <code>h2o</code> is limited</strong> by the fact that data modifications (e.g. for permutation importance) are done in R. This means that data sets are passed multiple times from R to h2o. This is too much overhead for <strong>data sets above 10’000 rows</strong>, say. In the future, this might be solved by moving data modifications to the h2o backend.</p>
</div>
<div id="training-a-linear-regression-and-a-random-forest-on-the-cars-data-set" class="section level2">
<h2 class="hasAnchor">
<a href="#training-a-linear-regression-and-a-random-forest-on-the-cars-data-set" class="anchor"></a>Training a linear regression and a random forest on the <code>cars</code> data set</h2>
<p>The <code>caret</code> package contains some wonderful data sets for playing, e.g. the cars data set.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r">data(cars)
str(cars)
#&gt; 'data.frame':    804 obs. of  18 variables:
#&gt;  $ Price      : num  22661 21725 29143 30732 33359 ...
#&gt;  $ Mileage    : int  20105 13457 31655 22479 17590 23635 17381 27558 25049 17319 ...
#&gt;  $ Cylinder   : int  6 6 4 4 4 4 4 4 4 4 ...
#&gt;  $ Doors      : int  4 2 2 2 2 2 2 2 2 4 ...
#&gt;  $ Cruise     : int  1 1 1 1 1 1 1 1 1 1 ...
#&gt;  $ Sound      : int  0 1 1 0 1 0 1 0 0 0 ...
#&gt;  $ Leather    : int  0 0 1 0 1 0 1 1 0 1 ...
#&gt;  $ Buick      : int  1 0 0 0 0 0 0 0 0 0 ...
#&gt;  $ Cadillac   : int  0 0 0 0 0 0 0 0 0 0 ...
#&gt;  $ Chevy      : int  0 1 0 0 0 0 0 0 0 0 ...
#&gt;  $ Pontiac    : int  0 0 0 0 0 0 0 0 0 0 ...
#&gt;  $ Saab       : int  0 0 1 1 1 1 1 1 1 1 ...
#&gt;  $ Saturn     : int  0 0 0 0 0 0 0 0 0 0 ...
#&gt;  $ convertible: int  0 0 1 1 1 1 1 1 1 0 ...
#&gt;  $ coupe      : int  0 1 0 0 0 0 0 0 0 0 ...
#&gt;  $ hatchback  : int  0 0 0 0 0 0 0 0 0 0 ...
#&gt;  $ sedan      : int  1 0 0 0 0 0 0 0 0 1 ...
#&gt;  $ wagon      : int  0 0 0 0 0 0 0 0 0 0 ...</pre></body></html></div>
<p>We then use the data to fit two types of regression to predict log(Price) by log(Mileage) and the other covariables. Car mades are already dummy coded. We will revert this in order to simplify the explainer process. Additionally, we represent some 0-1 dummies by nice, meaningful factors.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r">undo_dummies % 
  mutate(Price = log(Price),
         Mileage = log(Mileage),
         Made = undo_dummies(., c("Buick", "Cadillac", "Chevy", "Pontiac", "Saab", "Saturn"))) %&gt;% 
  mutate_at(c("Cruise", "Sound", "Leather"), no_yes)

# Response and covariables
y </pre></body></html></div>
</div>
<div id="flashlights" class="section level2">
<h2 class="hasAnchor">
<a href="#flashlights" class="anchor"></a>flashlights</h2>
<p>Then we collect all infos to build (multi-)flashlights, the core objects for explaining and comparing the models.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r">pred_fun </pre></body></html></div>
</div>
<div id="explaining-the-models" class="section level2">
<h2 class="hasAnchor">
<a href="#explaining-the-models" class="anchor"></a>Explaining the models</h2>
<p>Let us go through a selection of explainability tools.</p>
<div id="performance" class="section level3">
<h3 class="hasAnchor">
<a href="#performance" class="anchor"></a>Performance</h3>
<p>The models perform essentially similar.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r">light_performance(fls) %&gt;% 
  plot(fill = "darkred")</pre></body></html></div>
<p><img src="flashlight_h2o_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
</div>
<div id="importance" class="section level3">
<h3 class="hasAnchor">
<a href="#importance" class="anchor"></a>Importance</h3>
<p>Let’s study permutation importance regarding RMSE metric.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r">imp </pre></body></html></div>
<p><img src="flashlight_h2o_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
</div>
<div id="effects" class="section level3">
<h3 class="hasAnchor">
<a href="#effects" class="anchor"></a>Effects</h3>
<p>Now, let’s look at a couple of ways to visualize effects.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"># Individual conditional expectations (ICE). Using a seed guarantees the same observations across models
light_ice(fls, v = "Cylinder", n_max = 100, seed = 54) %&gt;% 
  plot(alpha = 0.1)</pre></body></html></div>
<p><img src="flashlight_h2o_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<div class="sourceCode" id="cb8"><html><body><pre class="r">
# Partial dependence profiles
light_profile(fls, v = "Cylinder") %&gt;% 
  plot()</pre></body></html></div>
<p><img src="flashlight_h2o_files/figure-html/unnamed-chunk-7-2.png" width="672"></p>
<div class="sourceCode" id="cb9"><html><body><pre class="r">
light_profile(fls, v = "Cylinder", by = "Leather") %&gt;% 
  plot()</pre></body></html></div>
<p><img src="flashlight_h2o_files/figure-html/unnamed-chunk-7-3.png" width="672"></p>
<div class="sourceCode" id="cb10"><html><body><pre class="r">
# Accumulated local effects
light_profile(fls, v = "Cylinder", type = "ale") %&gt;% 
  plot()</pre></body></html></div>
<p><img src="flashlight_h2o_files/figure-html/unnamed-chunk-7-4.png" width="672"></p>
<div class="sourceCode" id="cb11"><html><body><pre class="r">
# M-Plots
light_profile(fls, v = "Mileage", type = "predicted") %&gt;% 
  plot()</pre></body></html></div>
<p><img src="flashlight_h2o_files/figure-html/unnamed-chunk-7-5.png" width="672"></p>
<div class="sourceCode" id="cb12"><html><body><pre class="r">
# Response profiles, prediction profiles, partial dependence in one
eff % 
  plot() %&gt;% 
  plot_counts(eff, alpha = 0.3)</pre></body></html></div>
<p><img src="flashlight_h2o_files/figure-html/unnamed-chunk-7-6.png" width="672"></p>
</div>
<div id="interaction-strength" class="section level3">
<h3 class="hasAnchor">
<a href="#interaction-strength" class="anchor"></a>Interaction strength</h3>
<p>How strong are the pairwise interactions among the three most important predictors? Surprise, surprice: for the linear regression, there are none!</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r">light_interaction(fls, v = most_important(imp, 3), pairwise = TRUE, 
                           n_max = 30, seed = 63) %&gt;% 
  plot(fill = "darkred")</pre></body></html></div>
<p><img src="flashlight_h2o_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
</div>
<div id="global-surrogate" class="section level3">
<h3 class="hasAnchor">
<a href="#global-surrogate" class="anchor"></a>Global surrogate</h3>
<div class="sourceCode" id="cb14"><html><body><pre class="r">light_global_surrogate(fls) %&gt;% 
  plot()</pre></body></html></div>
<p><img src="flashlight_h2o_files/figure-html/unnamed-chunk-9-1.png" width="672"> ## Close the session</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r">h2o.shutdown()
#&gt; Are you sure you want to shutdown the H2O instance running at http://localhost:54321/ (Y/N)?</pre></body></html></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Michael Mayer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
